<!--
  ~ Copyright (c) 2017-2019 AxonIQ B.V. and/or licensed to AxonIQ B.V.
  ~ under one or more contributor license agreements.
  ~
  ~  Licensed under the AxonIQ Open Source License Agreement v1.0;
  ~  you may not use this file except in compliance with the license.
  ~
  -->

<script>
    //# sourceURL=extensions.js
    globals.pageView = new Vue(
            {
                el: '#extensions',
                data: {
                    extensions: [],
                    admin: globals.admin,
                    confirmData: {},
                    currentExtension: null,
                    roles: [],
                    newExtension: null,
                    componentKey: 0
                }, mounted() {
                    this.loadExtensions();
                }, beforeDestroy() {
                }, methods: {
                    loadExtensions() {
                        axios.get("v1/extensions").then(response => {
                            this.extensions = response.data;
                            this.componentKey++;
                        });
                    },
                    selectExtension(ext) {
                        axios.get("v1/extensions/configuration?extension=" + ext.name + "&version=" + ext.version).then(
                                response => {
                                    this.currentExtension = {
                                        name: ext.name,
                                        version: ext.version,
                                        configuration: response.data
                                    };
                                    this.newExtension = null;
                                });
                    },
                    deleteExtension(ext) {
                        if (confirm("Delete extension: " + ext.name)) {
                            let me = this;
                            axios.delete("v1/extensions?extension=" + ext.name + "&version=" + ext.version)
                                    .then(response => {
                                              this.currentExtension = null;
                                              this.newExtension = null;
                                              setTimeout(me.loadExtensions, 1000);
                                          }
                                    );
                        }
                    },
                    save(ext) {
                        let updatedExt = {extension: ext.name, version: ext.version, properties: {}};
                        for (let i = 0; i < ext.configuration.length; i++) {
                            let item = ext.configuration[i];
                            let properties = {};
                            for (let j = 0; j < item.properties.length; j++) {
                                let prop = item.properties[j];
                                properties[prop.id] = prop.value;
                            }
                            updatedExt.properties[item.id] = properties;
                        }
                        alert(JSON.stringify(updatedExt));
                        axios.post("v1/extensions/configuration", updatedExt).then(response => {
                            this.currentExtension = null;
                            this.loadExtensions();
                        })
                    },
                    install() {
                        this.currentExtension = null;
                        this.newExtension = {configuration: {}, start: true};
                    },
                    deleteConfigurationItem(key) {
                        delete this.newExtension.configuration[key];
                        this.$forceUpdate();
                    },
                    addConfigurationItem() {
                        if (!this.newExtension.configurationValue || !this.newExtension.configurationField) {
                            alert("Enter name and value");
                            return;
                        }
                        this.newExtension.configuration[this.newExtension.configurationField] = this.newExtension.configurationValue;
                        this.newExtension.configurationField = '';
                        this.newExtension.configurationValue = '';
                    },
                    canStop(extension) {
                        return extension.status === "Active";
                    },
                    canStart(extension) {
                        return extension.status === "Installed" || extension.status === "Resolved";
                    },
                    start(ext) {
                        let me = this;
                        axios.post("v1/extensions/status?extension=" + ext.name + "&version=" + ext.version
                                           + "&active=true")
                                .then(response => {
                                          this.currentExtension = null;
                                          this.newExtension = null;
                                          setTimeout(me.loadExtensions, 1000);
                                      }
                                );
                    },
                    stop(ext) {
                        let me = this;
                        axios.post("v1/extensions/status?extension=" + ext.name + "&version=" + ext.version
                                           + "&active=false")
                                .then(response => {
                                          this.currentExtension = null;
                                          this.newExtension = null;
                                          setTimeout(me.loadExtensions, 1000);
                                      }
                                );
                    },
                    hasOptions(attr) {
                        return attr.optionLabels && attr.optionLabels.length > 0;
                    },
                    add() {
                        let fd = new FormData();
                        let files = this.$refs.extensionFileRef.files[0];
                        if (files == undefined) {
                            alert("Select an extension file first")
                            return false;
                        }

                        let me = this;
                        if (me.newExtension.configurationField && me.newExtension.configurationValue) {
                            me.addConfigurationItem();
                        }
                        fd.append('bundle', files);
                        fd.append('configuration', JSON.stringify(me.newExtension.configuration));
                        axios.post("/v1/extensions?start=" + me.newExtension.start, fd,
                                   {
                                       headers: {
                                           'Content-Type': 'multipart/form-data'
                                       }
                                   }).then(response => {
                            setTimeout(me.loadExtensions, 1000);
                            me.newExtension = null;
                        });
                    }
                }
            });

</script>
<span id="extensions">
    <section id="extensionOverview">
        <div class="results singleHeader">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Version</th>
                        <th>Location</th>
                        <th>Used</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="extension in extensions" :key="componentKey">
                        <td>{{ extension.name }}</td>
                        <td>{{ extension.version }}</td>
                        <td>{{ extension.location }}</td>
                        <td>{{ extension.latestVersion }}</td>
                        <td>{{ extension.status }}</td>
                        <td v-if="admin">
                            <span @click="deleteExtension(extension)" title="Delete"><i
                                    class="far fa-trash-alt"/></span>
                            <span @click="selectExtension(extension)" title="Edit"><i class="fas fa-pencil-alt"/></span>
                            <span v-if="extension.status == 'Installed' || extension.status == 'Resolved'"
                                  @click="start(extension)" title="Start"><i class="far fa-play-circle"/></span>
                            <span v-if="extension.status == 'Active'" @click="stop(extension)" title="Stop"><i
                                    class="far fa-pause-circle"/></span>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="buttons" v-if="admin">
                <button @click.prevent="install()" class="button">Add</button>
            </div>
        </div>
    </section>

    <section id="extensionDetails" v-if="currentExtension">
        <div class="column wide">
            <form>
                <ul>
                    <li>
                        <span class="narrow">Name</span>
                        <span class="narrow">{{ currentExtension.name }}</span>
                    </li>
                    <li>
                        <span class="narrow">Version</span>
                        <span class="narrow">{{ currentExtension.version }}</span>
                    </li>
                    <li v-for="group in currentExtension.configuration">
                        <span class="narrow">{{ group.name }}</span>
                        <span>
                                <table class="nestedTable extensionProperties">
                                    <tbody>
                                        <tr v-for="attr in group.properties">
                                            <td width="20%">{{ attr.id }}</td>
                                            <td>
                                                <input v-if="!hasOptions(attr) && attr.type != 'password'" type="text"
                                                       v-model="attr.value"/>
                                                <input v-if="!hasOptions(attr) && attr.type == 'password'"
                                                       type="password" v-model="attr.value"/>
                                                <select v-if="hasOptions(attr)" v-model="attr.value">
                                                    <option v-for="(value,idx) in attr.optionValues"
                                                            :value="value">{{ attr.optionLabels[idx] }}</option>
                                                </select>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                        </span>
                    </li>
                    <li>
                        <span class="narrow">&nbsp;</span>
                        <span><button @click.prevent="save(currentExtension)" class="button">Save</button></span>
                    </li>
                </ul>
            </form>
        </div>
    </section>

    <section id="newExtensionDetails" v-if="newExtension">
        <div class="column wide">
                <form id="licenseForm" enctype="multipart/form-data">
                <ul>
                    <li>
                        <span class="narrow">Name</span>
                        <span class="narrow"><input type="file" ref="extensionFileRef" id="extensionFile"
                                                    name="extensionFile"/></span>
                    </li>
                    <li>
                        <span class="narrow">Start</span>
                        <span class="narrow"><input type="checkbox" v-model="newExtension.start"/></span>
                    </li>
                        <li>
                            <span class="narrow">Extension Properties</span>
                            <span>
                                <table class="nestedTable">
                                    <tbody>
                                        <tr v-for="key in Object.keys(newExtension.configuration)">
                                            <td style="width: 60%">{{ key }}</td>
                                            <td><input class="propertyValue" data-lpignore="true"
                                                       v-model="newExtension.configuration[key]"></td>
                                            <td style="width: 20px">
                                                <span @click="deleteConfigurationItem(key)"
                                                      title="Delete Configuration Property">
                                                    <i class="far fa-trash-alt"></i>
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="width: 60%">
                                                <input class="propertyValue" data-lpignore="true"
                                                       v-model="newExtension.configurationField">
                                            </td>
                                            <td>
                                                <input class="propertyValue" data-lpignore="true"
                                                       v-model="newExtension.configurationValue">
                                            </td>
                                            <td style="width: 20px">
                                    <span @click="addConfigurationItem()" title="Add Configuration Property">
                                        <i class="fas fa-plus"></i>
                                    </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </span>
                        </li>

                    <li>
                        <span class="narrow">&nbsp;</span>
                        <span><button @click.prevent="add(newExtension)" class="button">Save</button></span>
                    </li>
                </ul>
                </form>
        </div>
    </section>

</span>