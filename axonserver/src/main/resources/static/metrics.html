<!--
  ~  Copyright (c) 2017-2023 AxonIQ B.V. and/or licensed to AxonIQ B.V.
  ~  under one or more contributor license agreements.
  ~
  ~  Licensed under the AxonIQ Open Source License Agreement v1.0;
  ~  you may not use this file except in compliance with the license.
  ~
  -->
<script>
    globals.pageView = new Vue(
            {
                el: '#metrics',
                data: {
                    webSocketInfo: globals.webSocketInfo,
                    admin: globals.admin,
                    activeContext: '--all--',
                    contexts: [],
                    commands: {"mean": 0, "max": 0, percentileValues: []},
                    queries: {"mean": 0, "max": 0, percentileValues: []},
                    appendEvents: {"mean": 0, "max": 0, percentileValues: []},
                    commandSaturation: null,
                    querySaturation: null,
                    eventSaturation: null,
                    readSnapshots: {"mean": 0, "max": 0, percentileValues: []},
                    appendSnapshots: {"mean": 0, "max": 0, percentileValues: []},
                    readEvents: {"mean": 0, "max": 0, percentileValues: []},
                    errorCounters: null,
                    details: null,
                    detailsType: null,
                    detailsTitle: null,
                    status: null
                },
                mounted() {
                    axios.get("v1/public/visiblecontexts?includeAdmin=false").then(response => {
                        this.contexts = response.data;
                    });
                    this.reloadStatus();
                    this.timer = setInterval(this.reloadStatus, 5000);
                },
                beforeDestroy() {
                    clearInterval(this.timer);
                    if (this.subscription) {
                        this.subscription.unsubscribe();
                    }
                }, methods: {
                    reloadStatus: function () {
                        axios.get("v1/public/latency/queries" + this.contextParameter()).then(response => {
                            this.queries = response.data;
                            if (this.detailsType === "queries") {
                                this.details = this.queries.percentileValues;
                            }
                        });
                        axios.get("v1/public/latency/commands" + this.contextParameter()).then(response => {
                            this.commands = response.data;
                            if (this.detailsType === "commands") {
                                this.details = this.commands.percentileValues;
                            }
                        });
                        axios.get("v1/public/saturation/queries" + this.contextParameter()).then(response => {
                            this.querySaturation = response.data;
                        });
                        axios.get("v1/public/saturation/commands" + this.contextParameter()).then(response => {
                            this.commandSaturation = response.data;
                        });
                        axios.get("v1/public/latency/appendEvents" + this.contextParameter()).then(response => {
                            this.appendEvents = response.data;
                            if (this.detailsType === "appendEvents") {
                                this.details = this.appendEvents.percentileValues;
                            }

                        });
                        axios.get("v1/public/latency/appendSnapshot" + this.contextParameter()).then(response => {
                            this.appendSnapshots = response.data;
                            if (this.detailsType === "appendSnapshots") {
                                this.details = this.appendSnapshots.percentileValues;
                            }

                        });
                        axios.get("v1/public/latency/readSnapshots" + this.contextParameter()).then(response => {
                            this.readSnapshots = response.data;
                            if (this.detailsType === "readSnapshots") {
                                this.details = this.readSnapshots.percentileValues;
                            }

                        });
                        axios.get("v1/public/saturation/events" + this.contextParameter()).then(response => {
                            this.eventSaturation = response.data;
                        });
                        axios.get("v1/public/latency/readEvents" + this.contextParameter()).then(response => {
                            this.readEvents = response.data;
                            if (this.detailsType === "readEvents") {
                                this.details = this.readEvents.percentileValues;
                            }

                        });
                        axios.get("v1/public/errors" + this.contextParameter()).then(response => {
                            this.errorCounters = response.data;
                        });
                        axios.get("v1/public/traffic" + this.contextParameter()).then(response => {
                            this.status = response.data;
                        });
                    },
                    contextParameter() {
                        if (this.activeContext === '--all--') {
                            return "";
                        } else {
                            return "?targetContext=" + this.activeContext;
                        }
                    },
                    showCommandDetails() {
                        this.details = this.commands.percentileValues;
                        this.detailsType = "commands"
                        this.detailsTitle = "Command latency"
                        this.showModal('request-metrics-details');
                    },
                    showQueryDetails() {
                        this.details = this.queries.percentileValues;
                        this.detailsType = "queries"
                        this.detailsTitle = "Query latency"
                        this.showModal('request-metrics-details');
                    },
                    showModal: function (name) {
                        this.$modal.show(name);
                    },
                    hideModal: function (name) {
                        this.$modal.hide(name);
                    },
                    showAppendEventsDetails() {
                        this.details = this.appendEvents.percentileValues;
                        this.detailsType = "appendEvents"
                        this.detailsTitle = "Append events latency"
                        this.showModal('context-metrics-details');
                    },
                    showReadEventsDetails() {
                        this.details = this.readEvents.percentileValues;
                        this.detailsType = "readEvents"
                        this.detailsTitle = "Read events latency"
                        this.showModal('context-metrics-details');
                    },
                    showAppendSnapshotsDetails() {
                        this.details = this.appendSnapshots.percentileValues;
                        this.detailsType = "appendSnapshots"
                        this.detailsTitle = "Append snapshot latency"
                        this.showModal('context-metrics-details');
                    },
                    showReadSnapshotsDetails() {
                        this.details = this.readSnapshots.percentileValues;
                        this.detailsType = "readSnapshots"
                        this.detailsTitle = "Read snapshot latency"
                        this.showModal('context-metrics-details');
                    },
                    rtrim(text) {
                        if (text && text.length > 35) {
                            return "..." + text.substring(text.length - 35, text.length);
                        } else {
                            return text;
                        }
                    }
                }
            });

</script>
<div id="metrics">
    <div class="contextSelector">
        <span style="margin-left: 15px;">

        Active context:
        <select v-model="activeContext" @change="reloadStatus">
            <option>--all--</option>
            <option v-for="n in contexts">{{ n }}</option>
        </select>
        </span>
    </div>
    <br/>

    <h2>Latency</h2>

    <div class="column-wrapper">
        <div class="column configuration titleButton">
            <section>
                <h3>Command</h3>

                <ul>
                    <li>
                        <span>Mean</span>
                        <span class="number">{{ commands.mean | formatLatency }}</span>
                    </li>
                    <li>
                        <span>Max</span>
                        <span class="number">{{ commands.max | formatLatency }}</span>
                    </li>
                </ul>
                <button class="button small"
                        @click.prevent="showCommandDetails()">
                    Details
                </button>
                <h3>Query</h3>
                <ul>
                    <li>
                        <span>Mean</span>
                        <span class="number">{{ queries.mean | formatLatency }}</span>
                    </li>
                    <li>
                        <span>Max</span>
                        <span class="number">{{ queries.max | formatLatency }}</span>
                    </li>

                </ul>
                <button class="button small"
                        @click.prevent="showQueryDetails()">
                    Details
                </button>

            </section>
        </div>
        <div class="column status">
            <section>
                <h3>Events</h3>
                <h4>Append Events</h4>
                <ul>
                    <li>
                        <span>Mean</span>
                        <span class="number">{{ appendEvents.mean | formatLatency }}</span>
                    </li>
                    <li>
                        <span>Max</span>
                        <span class="number">{{ appendEvents.max | formatLatency }}</span>
                    </li>
                </ul>
                <button class="button small"
                        @click.prevent="showAppendEventsDetails()">
                    Details
                </button>
                <h4>Read Events</h4>
                <ul>
                    <li>
                        <span>Mean</span>
                        <span class="number">{{ readEvents.mean | formatLatency }}</span>
                    </li>
                    <li>
                        <span>Max</span>
                        <span class="number">{{ readEvents.max | formatLatency }}</span>
                    </li>

                </ul>
                <button class="button small"
                        @click.prevent="showReadEventsDetails()">
                    Details
                </button>
            </section>
        </div>
        <div class="column status">
            <section>
                <h3>Snapshots</h3>
                <h4>Append Snapshots</h4>
                <ul>
                    <li>
                        <span>Mean</span>
                        <span class="number">{{ appendSnapshots.mean | formatLatency }}</span>
                    </li>
                    <li>
                        <span>Max</span>
                        <span class="number">{{ appendSnapshots.max | formatLatency }}</span>
                    </li>

                </ul>
                <button class="button small"
                        @click.prevent="showAppendSnapshotsDetails()">
                    Details
                </button>
                <h4>Read Snapshots</h4>
                <ul>
                    <li>
                        <span>Mean</span>
                        <span class="number">{{ readSnapshots.mean | formatLatency }}</span>
                    </li>
                    <li>
                        <span>Max</span>
                        <span class="number">{{ readSnapshots.max | formatLatency }}</span>
                    </li>

                </ul>
                <button class="button small"
                        @click.prevent="showReadSnapshotsDetails()">
                    Details
                </button>
            </section>
        </div>
    </div>

    <h2>Traffic</h2>

    <div class="column-wrapper">
        <div class="column configuration">
            <section>
                <h3>Command</h3>

                <ul v-if="status">
                    <li>
                        <span>Total received </span>
                        <span class="number">{{ status.commandRate.count }}</span>
                    </li>
                    <li>
                        <span>Received / second (last minute)</span>
                        <span class="number">{{ status.commandRate.oneMinuteRate | formatLatency }}</span>
                    </li>
                    <li v-if="trafficDetails">
                        <span>Received / second (last 5 minutes)</span>
                        <span class="number">{{ status.commandRate.fiveMinuteRate | formatLatency }}</span>
                    </li>
                    <li v-if="trafficDetails">
                        <span>Received / second (last 15 minutes)</span>
                        <span class="number">{{ status.commandRate.fifteenMinuteRate | formatLatency }}</span>
                    </li>
                </ul>
                <h3>Query</h3>

                <ul v-if="status">
                    <li>
                        <span>Total received </span>
                        <span class="number">{{ status.queryRate.count }}</span>
                    </li>
                    <li>
                        <span>Received / second (last minute)</span>
                        <span class="number">{{ status.queryRate.oneMinuteRate | formatLatency }}</span>
                    </li>
                    <li v-if="trafficDetails">
                        <span>Received / second (last 5 minutes)</span>
                        <span class="number">{{ status.queryRate.fiveMinuteRate | formatLatency }}</span>
                    </li>
                    <li v-if="trafficDetails">
                        <span>Received / second (last 15 minutes)</span>
                        <span class="number">{{ status.queryRate.fifteenMinuteRate | formatLatency }}</span>
                    </li>
                </ul>
            </section>

        </div>

        <div class="column status">
            <section>
                <h3>Events</h3>
                <h4>Append events</h4>

                <ul v-if="status">
                    <li>
                        <span>Total received </span>
                        <span class="number">{{ status.eventRate.count }}</span>
                    </li>
                    <li>
                        <span>Received / second (last minute)</span>
                        <span class="number">{{ status.eventRate.oneMinuteRate | formatLatency }}</span>
                    </li>
                    <li v-if="trafficDetails">
                        <span>Received / second (last 5 minutes)</span>
                        <span class="number">{{ status.eventRate.fiveMinuteRate | formatLatency }}</span>
                    </li>
                    <li v-if="trafficDetails">
                        <span>Received / second (last 15 minutes)</span>
                        <span class="number">{{ status.eventRate.fifteenMinuteRate | formatLatency }}</span>
                    </li>
                </ul>
                <h4>Read Aggregate</h4>

                <ul v-if="status">
                    <li>
                        <span>Total received </span>
                        <span class="number">{{ status.readAggregateRate.count }}</span>
                    </li>
                    <li>
                        <span>Received / second (last minute)</span>
                        <span class="number">{{ status.readAggregateRate.oneMinuteRate | formatLatency }}</span>
                    </li>
                    <li v-if="trafficDetails">
                        <span>Received / second (last 5 minutes)</span>
                        <span class="number">{{ status.readAggregateRate.fiveMinuteRate | formatLatency }}</span>
                    </li>
                    <li v-if="trafficDetails">
                        <span>Received / second (last 15 minutes)</span>
                        <span class="number">{{ status.readAggregateRate.fifteenMinuteRate | formatLatency }}</span>
                    </li>
                </ul>
            </section>

        </div>
        <div class="column status">
            <section>
                <h3>Snapshots</h3>
                <h4>Append Snapshot</h4>

                <ul v-if="status">
                    <li>
                        <span>Total received </span>
                        <span class="number">{{ status.snapshotRate.count }}</span>
                    </li>
                    <li>
                        <span>Received / second (last minute)</span>
                        <span class="number">{{ status.snapshotRate.oneMinuteRate | formatLatency }}</span>
                    </li>
                    <li v-if="trafficDetails">
                        <span>Received / second (last 5 minutes)</span>
                        <span class="number">{{ status.snapshotRate.fiveMinuteRate | formatLatency }}</span>
                    </li>
                    <li v-if="trafficDetails">
                        <span>Received / second (last 15 minutes)</span>
                        <span class="number">{{ status.snapshotRate.fifteenMinuteRate | formatLatency }}</span>
                    </li>
                </ul>
                <h4>Read Snapshot</h4>
                <ul v-if="status">
                    <li>
                        <span>Total received </span>
                        <span class="number">{{ status.readSnapshotRate.count }}</span>
                    </li>
                    <li>
                        <span>Received / second (last minute)</span>
                        <span class="number">{{ status.readSnapshotRate.oneMinuteRate | formatLatency }}</span>
                    </li>
                    <li v-if="trafficDetails">
                        <span>Received / second (last 5 minutes)</span>
                        <span class="number">{{ status.readSnapshotRate.fiveMinuteRate | formatLatency }}</span>
                    </li>
                    <li v-if="trafficDetails">
                        <span>Received / second (last 15 minutes)</span>
                        <span class="number">{{ status.readSnapshotRate.fifteenMinuteRate | formatLatency }}</span>
                    </li>
                </ul>
            </section>
        </div>
    </div>

    <h2>Errors</h2>
    <div class="column-wrapper">
        <div class="column configuration">
            <section>
                <h3>Command</h3>
                <ul v-if="errorCounters">
                    <li>
                        <span>Total errors</span>
                        <span class="number">{{ errorCounters.commandErrors }}</span>
                    </li>
                </ul>
            </section>
        </div>
        <div class="column status">
            <section>
                <h3>Query</h3>
                <ul v-if="errorCounters">
                    <li>
                        <span>Total errors</span>
                        <span class="number">{{ errorCounters.queryErrors }}</span>
                    </li>
                </ul>
            </section>
        </div>
        <div class="column status">
            <section>
                <h3>Event Store</h3>
                <ul v-if="errorCounters">
                    <li>
                        <span>Total append errors</span>
                        <span class="number">{{ errorCounters.appendErrors }}</span>
                    </li>
                    <li>
                        <span>Total read errors</span>
                        <span class="number">{{ errorCounters.readErrors }}</span>
                    </li>
                </ul>
            </section>
        </div>
    </div>

    <h2>Saturation</h2>
    <div class="column-wrapper">
        <div class="column configuration">
            <section>
                <h3>Command</h3>

                <ul v-if="commandSaturation">
                    <li>
                        <span>Active commands</span>
                        <span class="number">{{ commandSaturation.active }}</span>
                    </li>
                    <li>
                        <span>Queued commands</span>
                        <span class="number">{{ commandSaturation.waiting }}</span>
                    </li>
                </ul>
            </section>
        </div>
        <div class="column status">
            <section>
                <h3>Queries</h3>

                <ul v-if="querySaturation">
                    <li>
                        <span>Active queries</span>
                        <span class="number">{{ querySaturation.active }}</span>
                    </li>
                    <li>
                        <span>Queued queries</span>
                        <span class="number">{{ querySaturation.waiting }}</span>
                    </li>
                </ul>
            </section>
        </div>
        <div class="column status">
            <section>
                <h3>Events</h3>

                <ul v-if="eventSaturation">
                    <li>
                        <span>Active aggregate reads</span>
                        <span class="number">{{ eventSaturation.aggregateReads }}</span>
                    </li>
                    <li>
                        <span>Active writes</span>
                        <span class="number">{{ eventSaturation.eventWrites }}</span>
                    </li>
                    <li>
                        <span>Active streams</span>
                        <span class="number">{{ eventSaturation.eventStreams }}</span>
                    </li>
                </ul>
            </section>
        </div>
    </div>

    <modal name="request-metrics-details" width="1000" height="550">
        <div style="margin: 10px;  width: 980px; height: 100%">
            <div style="width: 100%; height: 490px; overflow: auto">
                <h2>{{ detailsTitle }}</h2>
                <table v-if="details">
                    <thead>
                    <tr>
                        <th></th>
                        <th style="width: 30%"></th>
                        <th></th>
                        <th style="width: 80px"></th>
                        <th colspan="3" style="width: 300px; text-align: center">Percentiles</th>
                    </tr>

                    <tr>
                    <th>Context</th>
                    <th>Request</th>
                    <!--                            <th>Source</th>-->
                    <th>Target</th>
                    <th>Count</th>
                    <th style="width: 80px; text-align: right">50%</th>
                    <th style="width: 80px; text-align: right">95%</th>
                    <th style="width: 80px; text-align: right">99%</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="c in details">
                    <td>{{ c.tags.context }}</td>
                    <td>{{ rtrim(c.tags.request) }}</td>
                    <!--                            <td>{{ c.tags.source }}</td>-->
                    <td>{{ c.tags.target }}</td>
                    <td>{{ c.latency.count }}</td>
                    <td style="text-align: right">{{ c.latency.percentileValues[0].value | formatLatency }}</td>
                    <td style="text-align: right">{{ c.latency.percentileValues[1].value | formatLatency }}</td>
                    <td style="text-align: right">{{ c.latency.percentileValues[2].value | formatLatency }}</td>
                </tbody>
                </table>
            </div>
            <button @click.prevent="hideModal('request-metrics-details')" class="button">Ok</button>
        </div>
    </modal>

    <modal name="context-metrics-details" width="800" height="550">
        <div style="margin: 10px;  width: 780px; height: 100%">
            <div style="width: 100%; height: 490px; overflow: auto">
                <h2>{{ detailsTitle }}</h2>
                <table v-if="details">
                    <thead>
                    <tr>
                        <th></th>
                        <th style="width: 100px"></th>
                        <th colspan="3" style="width: 300px; text-align: center">Percentiles</th>
                    </tr>
                    <tr>
                        <th>Context</th>
                        <th>Count</th>
                    <th style="width: 100px; text-align: right">50%</th>
                    <th style="width: 100px; text-align: right">95%</th>
                    <th style="width: 100px; text-align: right">99%</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="c in details">
                    <td>{{ c.tags.context }}</td>
                    <td>{{ c.latency.count }}</td>
                    <td style="text-align: right">{{ c.latency.percentileValues[0].value | formatLatency }}</td>
                    <td style="text-align: right">{{ c.latency.percentileValues[1].value | formatLatency }}</td>
                    <td style="text-align: right">{{ c.latency.percentileValues[2].value | formatLatency }}</td>
                </tbody>
                </table>
            </div>
            <button @click.prevent="hideModal('context-metrics-details')" class="button">Ok</button>
        </div>
    </modal>

</div>